# amclのパラメータについて

amclノードの構成に使用できるROS パラメーターには，フィルター全体，レーザーモデル，オドメトリモデルの3つのカテゴリがあります

---

# 01. 総体的なフィルタ
|パラメータ名|型|デフォルト値|単位|意味|
|---|---|---|---|---|
|min_particles|int|100|-|パーティクルの最小数|
|max_particles|int|500|-|パーティクルの最大数<br>パーティクル数は精度に大きな影響を与えるが，最大数を大きくしすぎた場合CPUの負荷の問題が発生する場合があります|
|kld_err|double|0.01|-|	推定位置の誤差の度合い<br>大きくするとパーティクル数が少なくなります<br>倍にするとパーティクル数が約半分になります|
|kld_z|double|150.0|-|上側標準正規分位数<br>kdl_zとセットで用いられる推定計算係数<br>大きくするとパーティクル数が少し多くなります|
|update_min_d|double|0.2|m|パーティクルフィルタの更新(予測)を実行するかを判定する移動距離の閾値<br>更新時，ある程度の前回との差分がないと予測が収束してしまい，間違った観察位置で固定されてしまいます<br>オドメトリトピックの発信頻度が高ければ(30Hzくらいあれば)デフォルトの値で問題ありません，低い場合は値を大きくします|
|update_min_a|double|π/6.0|rad|パーティクルフィルタの更新(予測)を実行するかを判定する回転角度の差の閾値<br>更新時，ある程度の前回との差分がないと予測が収束してしまい，間違った観察位置で固定されてしまいます<br>オドメトリトピックの発信頻度が高ければ(30Hzくらいあれば)デフォルトの値で問題ありません，低い場合は値を大きくします|
|resample_interval|int|2|-|リサンプリングを行うかを判定するパーティクルフィルタが更新(予測)された回数<br>オドメトリの精度がよい場合は予測の精度がよくなるため，値を大きくしても問題ありません|
|transform_tolerance|double|0.1|s|入力となるトピック群の時間誤差の許容値<br>各センサデータの間隔が長い場合はこの値を伸ばして調整する必要があります<br>センサ側の性能を調整するほうが方向性としては正しいです|
|recovery_alpha_slow|double|0.0|-|リサンプリング時のランダムパーティクルの割合計算に使用する低速指数移動平均の平滑化係数<br>無効にする場合は0.0を指定します<br>指定する場合，適切な値は0.001です|
|recovery_alpha_fast|double|0.0|-|リサンプリング時のランダムパーティクルの割合計算に使用する高速指数移動平均の平滑化係数<br>無効にする場合は0.0を指定します<br>指定する場合， 適切な値は0.1です|
|initial_pose_x|double|0.0|m|ガウス分布でフィルターを初期化するために使用する初期x座標平均<br>実行する際の初期値を設定します|
|initial_pose_y|double|0.0|m|ガウス分布でフィルターを初期化するために使用する初期y座標平均<br>実行する際の初期値を設定します|
|initial_pose_a|double|0.0|rad|ガウス分布でフィルターを初期化するために使用する初期ヨー角平均<br>実行する際の初期値を設定します|
|initial_cov_xx|double|0.5*0.5|m^2|ガウス分布でフィルターを初期化するために使用する初期x座標共分散<br>基本的にデフォルト値で問題ありません<br>ロボットの初期姿勢の分散(x)値が大きくなるほどばらまくパーティクルの分布，角度が広がる|
|initial_cov_yy|double|0.5*0.5|m^2|ガウス分布でフィルターを初期化するために使用する初期y座標共分散<br>基本的にデフォルト値で問題ありません<br>ロボットの初期姿勢の分散(y)値が大きくなるほどばらまくパーティクルの分布，角度が広がる|
|initial_cov_aa|double|(π/12)*(π/12)|rad^2|ガウス分布でフィルターを初期化するために使用する初期ヨー角共分散<br>基本的にデフォルト値で問題ありません<br>ロボットの初期姿勢の分散(yaw)値が大きくなるほどばらまくパーティクルの分布，角度が広がる|
|gui_publish_rate|double|-1.0|Hz|視覚化のためにスキャン結果と軌跡がPublishされる最大レート<br>無効にする場合は-1.0を指定します<br>視覚化の要素のため精度には影響しません|
|save_pose_rate|double|0.5|HZ|変数initial_pose_* およびinitial_cov_*に対して，サーバーへの最後の推定ポーズと共分散を保存する最大レート<br>この保存されたポーズは，以降の実行でフィルターを初期化するために使用されます<br>無効にする場合は-1.0を指定します|
|use_map_topic|bool|false|-|trueに設定すると，起動時にマップを読み込むのではなく，Subscribeしたマップを使用します<br>システム起動中に地図切替を行いたい場合はtrueにします|
|first_map_only|bool|false|-|trueに設定すると，Subscribeするたびに新しいマップに更新するのではなく，最初のマップのみを使用します|

---

# 02. レーザーモデル
- 重みの合計は1になるようにしてください
- ビームモデルでは，z_hit，z_short，z_max，z_randのすべての重みを使用します
- 尤度モデルは，z_hitとz_randのみを使用します

|パラメータ名|型|デフォルト値|単位|意味|
|---|---|---|---|---|
|laser_min_range|double|-1.0|m|	最小スキャン範囲<br>レーザー値が指定値以下の場合，レーザーの最大値の値(laser_max_range)を設定します<br> 0以下の値を指定すると，トピック（LiDAR）に設定されているレーザーの最小範囲が使用されます<br>基本的にトピックで設定されている値を使用するほうが良いです|
|laser_max_range|double|-1.0|m|最大スキャン範囲<br>0以下の値を指定すると，トピックに設定されているレーザーの最大範囲が使用されます<br>基本的にトピックで設定されている値を使用するほうが良いです|
|laser_max_beams|int|30|-|レーザー1セットごとに等間隔に取得したサンプル個数<br>比較的精度の高いLiDARなら増やしたほうが良い成果になりやすいです|
|laser_z_hit|double|0.95|-|ビームの尤度を計算する際の，ガウシアンノイズの重み<br>ROSのチュートリアルで使用されている設定値を使用することが多いです|
|laser_z_short|double|0.1|-|ビームの尤度を計算する際の，障害物対策ノイズの重み<br>likelihood_fieldモデルでは使用されません<br>ROSのチュートリアルで使用されている設定値を使用することが多いです|
|laser_z_max|double|0.05|-|	ビームの尤度を計算する際の，センサ最大距離ノイズの重み<br>likelihood_fieldモデルでは使用されません<br>ROSのチュートリアルで使用されている設定値を使用することが多いです|
|laser_z_rand|double|0.05|-|ビームの尤度を計算する際の，ランダムノイズの重み<br>ROSのチュートリアルで使用されている設定値を使用することが多いです|
|laser_sigma_hit|double|0.2|-|ガウシアンノイズの標準偏差<br>ROSのチュートリアルで使用されている設定値を使用することが多いです|
|laser_lambda_short|double|0.1|-|z_shortによる尤度加算の分布を調整するパラメータ<br>ROSのチュートリアルで使用されている設定値を使用することが多いです|
|laser_likelihood_max_dist|double|2.0|m|LikelihoodField生成の際に，障害物からフィールドを広げる距離<br>ROSのチュートリアルで使用されている設定値を使用することが多いです|
|laser_model_type|string|likelihood_field|-|beam，likelihood_field，likelihood_field_prob内の使用するモデル<br>基本的にlikelihood_fieldモデルを使用します|

---

# 03. オドメトリモデル
- odom_model_typeが「diff」の場合，「Probabilistic Robotics」p136のsample_motion_model_odometryアルゴリズムを使用します
    - このモデルでは本で定義されているように， odom_alpha1からodom_alpha4までのノイズパラメーターを使用します
- odom_model_typeが「omni」の場合， odom_alpha1~odom_alpha5を使用します
    - 最初の4つのパラメーターの意味は， 「diff」モデルの際の意味とほぼ同じです
    - 5番目のパラメーターは，向いている方向に移動するロボットに対するパラメータとなります
- 「diff-corrected」および「omni-corrected」では，ノイズが元のモデルに対してルートをかけたものになっているため，odom_alphaパラメーターはデフォルト設定のままでは，うまく機能しないと思われます
    - これらの値をおそらくもっと小さくする必要があります([参照](http://answers.ros.org/question/227811/tuning-amcls-diff-corrected-and-omni-corrected-odom-models))

|パラメータ名|型|デフォルト値|単位|意味|
|---|---|---|---|---|
|odom_model_type|string|diff|-|使用するオドメトリモデル<br>diff ，omni ，diff-corrected，omni-correctedのいずれかが設定できます<br>新規で使用する場合は，*-correctedを使用したほうが良いと思われます|
|odom_alpha1|double|0.2|-|現在のロボットの動きの回転成分から，計算するオドメトリの回転成分に対するノイズ<br>大きくするとロボットの回転が大きい時にオドメトリの回転の信頼度が下がります<br>オドメトリのノイズやエンコーダの反応が遅いなどの場合は，2.0や5.0など，かなり大きい値を指定した方が良い結果となる傾向があります|
|odom_alpha2|double|0.2|-|現在のロボットの動きの並進成分から，計算するオドメトリの回転成分に対するノイズ<br>大きくするとロボットの平行移動が大きい時にオドメトリの回転の信頼度が下がります<br>オドメトリのノイズやエンコーダの反応が遅いなどの場合は，2.0や5.0など，かなり大きい値を指定した方が良い結果となる傾向があります|
|odom_alpha3|double|0.2|-|現在のロボットの動きの並進成分から，計算するオドメトリの平行移動成分に対するノイズ<br>大きくするとロボットの平行移動が大きい時にオドメトリの平行移動の信頼度が下がります<br>よほどスリップするような環境でなければ，直線方向の誤差は出にくいです|
|odom_alpha4|double|0.2|-|現在のロボットの動きの回転成分から，計算するオドメトリの平行移動成分に対するノイズ<br>大きくすると推定しているロボット回転が大きい場合にオドメトリの平行移動の信頼度が下がります<br>よほどスリップするような環境でなければ，直線方向の誤差は出にくいです|
|odom_alpha5|double|0.2|-|ホロノミック体の場合の直線（y軸）誤差<br>（モデルがomniの場合にのみ使用）よほどスリップするような環境でなければ，直線方向の誤差は出にくいです|
|laser_model_type|string|odom|-|オドメトリ原点座標のフレーム名|
|odom_frame_id|string|base_link|-|ロボットベース原点座標のフレーム名|
|global_frame_id|string|map|-|	地図原点座標のフレーム名|
|tf_broadcast|bool|true|-|TF情報をpublishするか否か|

---

# 参考サイト
- [ROSのナビゲーションamclについて理解を深めてみる](https://sy-base.com/myrobotics/ros/ros-amcl/)
- [amclパラメーター](http://rosrosrosrosros.blogspot.com/2013/09/amcl.html)
- [amcl](https://robo-marc.github.io/navigation_documents/amcl.html)

---

- [Topに戻る](https://gitlab.com/TeamSOBITS/sobit_navigation_stack#sobit-navigation-stack)